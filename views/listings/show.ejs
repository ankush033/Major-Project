<% layout('/layouts/boilerPlate') %>

<div class="container mt-3">
  <!-- Title + Edit/Delete Buttons -->
  <div class="row">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h2 class="fw-bold"><%= listing.title %></h2>

      <% if (currentUser && listing.owner && String(currentUser._id) === String(listing.owner._id)) { %>
        <div class="d-flex gap-2">
          <a href="/listings/<%= listing._id %>/edit" class="btn btn-warning btn-sm">Edit</a>
          <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="d-inline">
            <button class="btn btn-danger btn-sm">Delete</button>
          </form>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Listing Card -->
  <div class="card col-12 col-md-6 offset-md-3 mt-3 shadow-sm">
    <img 
      src="<%= listing.image?.url || 'https://via.placeholder.com/400x300' %>" 
      class="card-img-top rounded" 
      alt="Listing Image"
    >
    <div class="card-body">
      <p class="text-muted">Owned by <i><%= listing.owner?.username || 'Unknown' %></i></p>
      <p><%= listing.description %></p>
      <p><strong>Price:</strong> â‚¹<%= Number(listing.price).toLocaleString("en-IN") %></p>
      <p><strong>Location:</strong> <%= listing.location %></p>
      <p><strong>Country:</strong> <%= listing.country %></p>
    </div>
  </div>

  <!-- ðŸ—ºï¸ Mapbox Map -->
  <div class="col-12 col-md-6 offset-md-3 mt-4 shadow-sm p-3 rounded">
    <div id="map" 
         data-lng="<%= listing.geometry?.coordinates?.[0] || 78.9629 %>" 
         data-lat="<%= listing.geometry?.coordinates?.[1] || 20.5937 %>" 
         data-title="<%= listing.title %>" 
         data-location="<%= listing.location %>" 
         style="height: 400px; border-radius: 10px;"></div>

    <!-- âœ… Reserved Button -->
    <% if (currentUser) { %>
      <button id="reserveBtn" class="btn btn-success mt-3 w-100">Reserve</button>
    <% } %>
  </div>

  <!-- â­ Reviews Section -->
  <div class="col-12 col-md-6 offset-md-3 mt-4 review-section">
    <h4 class="fw-bold mb-3">Reviews</h4>

    <% listing.reviews.forEach(review => { %>
      <div class="card mb-2 shadow-sm">
        <div class="card-body">
          <strong><%= review.author.username %></strong> - <%= review.rating %>/5
          <p><%= review.comment %></p>

          <% if (currentUser && String(currentUser._id) === String(review.author._id)) { %>
            <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST">
              <button class="btn btn-sm btn-danger">Delete Review</button>
            </form>
          <% } %>
        </div>
      </div>
    <% }) %>

    <% if (currentUser) { %>
      <form action="/listings/<%= listing._id %>/reviews" method="POST" class="mt-3">
        <div class="mb-3">
          <label class="form-label">Rating</label>
          <div class="star-rating">
            <input type="radio" name="review[rating]" id="rating-5" value="5" required><label for="rating-5"><i class="fa fa-star"></i></label>
            <input type="radio" name="review[rating]" id="rating-4" value="4"><label for="rating-4"><i class="fa fa-star"></i></label>
            <input type="radio" name="review[rating]" id="rating-3" value="3"><label for="rating-3"><i class="fa fa-star"></i></label>
            <input type="radio" name="review[rating]" id="rating-2" value="2"><label for="rating-2"><i class="fa fa-star"></i></label>
            <input type="radio" name="review[rating]" id="rating-1" value="1"><label for="rating-1"><i class="fa fa-star"></i></label>
          </div>
        </div>

        <div class="mb-3">
          <label for="comment" class="form-label">Comment</label>
          <textarea name="review[comment]" id="comment" rows="3" class="form-control" required></textarea>
        </div>
        <button class="btn btn-outline-dark w-100">Add Review</button>
      </form>
    <% } else { %>
      <p><a href="/login">Login</a> to post a review.</p>
    <% } %>
  </div>
</div>

<!-- Include Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

<!-- âœ… Flash Message Container -->
<div id="reserveFlash" class="alert alert-success fixed-top text-center m-3 d-none" role="alert">
  Reserved!
</div>

<!-- âœ… Reserve Button Script -->
<script>
  const reserveBtn = document.getElementById("reserveBtn");
  const flash = document.getElementById("reserveFlash");

  if(reserveBtn){
    reserveBtn.addEventListener("click", () => {
      // Show flash message
      flash.classList.remove("d-none");
      flash.classList.add("show");

      // Hide after 2 seconds
      setTimeout(() => {
        flash.classList.add("d-none");
      }, 2000);

      // Disable button after click
      reserveBtn.disabled = true;
      reserveBtn.textContent = "Reserved";
    });
  }
</script>
